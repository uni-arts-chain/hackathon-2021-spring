# Project

## 1. 简介

### Shopbring: 建立连接Polkadot生态系统的去中心化电商代购平台

我们团队将利用Substrate建立一个去中心化的电商代购平台，并且以平行链方式连接到Polkadot生态系统。我们将项目命名为Shopbring，即Shopping-bring的意涵。Shopbring为Polkadot生态系统用户提供以加密货币作为支付方式的电商购物渠道，为传统电商用户提供进入Polkadot生态系统的快捷入口。最终目的是促使传统电商进入到Polkadot生态系统，共同建设一个经济繁荣的去中心化电商平台。

## 2. 背景

### 2.1 DeFi创造了新的金融服务模式

DeFi，全称Decentralized Finance，中文名称是“去中心化金融”，也被称为“开放式金融”，旨在通过区块链技术消除或改善传统金融行业弊端，简化服务流程、节约成本，从而更好的提高金融服务业效率。

说起DeFi，最早是加密货币借贷平台Dharma创始人Brendan Forster在2018年提出的，后来人们对DeFi的定义进一步明确：所有基于区块链网络的数字资产、智能合约、协议以及分布式应用（DApp）等金融产品和金融活动都可以称为DeFi。目前的DeFi 服务种类包含了稳定币、去中心化交易所、借贷平台、合成资产、衍生性商品、支付、流动性挖矿等。

**相比传统金融DeFi有三大优势：**

1. DeFi实现投资者直接拥有金融资产，DeFi提供了更安全的价值存储手段。
1. DeFi无需第三方的信用评定，实现资本供需双方自主决定交易过程。
1. DeFi能够进一步提升交易效率、实现资本的更高效分配，推动建立更丰富的>金融业务生态。

### 2.2 DeFi现存的局限性

#### 底层区块链网络的局限性

目前以太坊是最多开发者和使用者的区块链网络，绝大多数的DeFi项目都以智能合约方式部署在以太坊网络。DeFi在蓬勃发展的过程中遇到了瓶颈，其原因是以太坊网络是单链POW共识机制，当网络产生大量交易时，会逐渐推高Gas价格，一方面使得手续费低的交易延迟，另一方面使得新的交易成本变高。结果就是高昂的交易成本导致用户放弃使用DeFi。

#### 稳定币应用的局限性

区块链网络发行稳定币，都采用抵押物发行的方式，只是抵押物的不同，通过加密货币作为抵押物，能实现真正的去中心化。现在稳定币的用途主要是用于与加密货币的交易，受到区块链网络性能的局限，稳定币用作支付仍然不现实。同时稳定币要兑换成法币，也是十分麻烦的，支持法币兑换加密货币的交易所都要求做严格的KYC认证，避免黑钱流入平台，要保证用户资金安全。

#### 系统安全风险极高

大部分DeFi项目都基于智能合约开发，合约代码越复杂，写出漏洞概率越大。以太坊缺乏顶层设计的去中心化治理机制，当智能合约漏洞导致用户重大损失时，网络只能通过强制的硬分叉升级才能解决危机。著名的The DAO事件导致了以太坊社区分裂出ETH和ETC。时至今日，已有好几个出名的DeFi项目因漏洞而遭受过黑客盗窃。

### 2.3 Polkadot为DeFi带来新的解决方案

Polkadot是一个允许独立区块链互相交换信息和价值的跨链技术。它拥有低门槛、灵活、自治经济活动，共享安全性等特点。
DeFi开发者可以利用Substrate重新建立一个属于自己社区的去中心化系统，充分满足性能和治理需求。通过租用平行链插槽连接到Polkadot网络，获得与中继链相同的共识安全。
通过Polkadot的跨链消息传递（XCMP）技术，平行链可以扩大业务能力。

## 3. 可行性分析

随着DeFi商业模式的成熟，未来将衍生出以加密货币作为支付方式的需求。我们团队建立Shopbring，就是为了实现加密货币购物的第一步。

### 3.1 从市场需求方面分析

Shopbring因应了两类人的需求：

- 被DeFi高收益回报吸引，希望投入少许资金参与DeFi理财，但没有加密货币买卖经验的人群。
- 不想频繁地在场外交易市场出入法币，希望直接使用加密货币购物，又能灵活参与DeFi理财的人群。

### 3.2 从技术实现可行性分析

- 我们使用Substrate建立平台，不但业务功能可以自由定制，而且可以复用Polkadot开发者的开源pallets库。Substrate无叉升级这个特性，使得我们开发计划更有把握。
- 我们无需再建立一套DeFi系统，只需要通过租用平行链插槽，Shopbring就可以与其他DeFi平行链传递消息，调用DeFi业务功能，例如：币币兑换，质押理财等等跨链事务。
- Shopbring是独立的一条平行链，交易性能获得极大的优化，同时交易手续费可以降到最低，电子支付体验媲美中心化的支付系统。

### 3.3 从商业模式可行性分析

Shopbring的消费者不是直接使用加密货币支付电商平台，他是先把加密货币锁定在系统，代购者按照代购单信息，购买指定电商平台的商品，发货给消费者的地址。消费者收到货后，在链上确认到货，系统把锁定的金额转账给代购者，代购者收到金额后，在电商平台确认收货。

> 在购物过程中，消费者没有使用过法币，支付金额不需要第三方托管，Polkadot网络共识保证了资金安全；代购者与电商平台之间是法币交易，资金安全有国家合规的支付公司保证。假设代购者没有完成代购任务，他也无法拿到链上锁定的金额。假设代购者完成了代购任务，消费者收到商品而不确认到货，他也无法收回解锁金额。难以避免出现这样的纠纷，所以我们系统还需要引入“仲裁者”这个角色，通过纠纷仲裁方式，解决锁定金额的归属问题。为了平台能健康成长，我们还需要建立一个信用激励机制，好的行为增加信用，坏的行为扣减信用，根据信用值比例空投代币。

## 4. 项目介绍

### 4.2 项目特点

- **与polkadot共享网络共识安全**。项目基于Substrate框架开发，以平行链方式连接Polkadot网络，我们不必为网络共识投入长期维护成本。
- **无需许可准入**。Shopbring不需要KYC认证，任何人拥有Polkadot账户都可以发布代购需求和提供代购服务。
- **去中心化仲裁者**。为了维护平台健康发展，我们建立起仲裁者机制，用户在代购过程中出现纠纷时，任何一方都可以举报违规行为，系统随机分配1名仲裁者协助仲裁。
- **信用增值模型**。为了刺激更多用户在Shopbring经常购物，我们建立起信用成长制度。当代购交易完成后，通过验证购物票据，系统将金额转化为信用值增加到交易双方。获得信用值的账户可以领取原生代币作为奖励。
- **隐私信息加密**。在建立代购交易单时，双方先协商密码，对代购信息加密，信息只有双方解密可见。
- **支持多币种支付**。代购交易支持多币种支付，使加密货币应用更广。

### 4.3 核心业务设计

#### 4.3.1 业务角色

- **消费者**。发布代购交易单，使用加密货币作为支付方式。
- **代购者**。接受代购交易单，在电商平台完成实际商品买卖，让商家把商品发货给真实消费者。
- **仲裁者**。普通用户注册成为仲裁者需要冻结一定原生代币金额，成为仲裁者后，主要负责仲裁代购交易纠纷，完成仲裁可以获得信用增值。
- **验票人**。要注册成为验票人，需要获得理事会多数通过。验票人需要运行一个链下验证购物票据的服务，例如：验证商品发票真伪服务。
- **理事会**。按照Polkadot治理规则选举理事会成员。
- **技术委会**。按照Polkadot治理规则由理事会建立技术委员会。
- **国库**。参考Polkadot国库设计，资金来源于代币激励模型，交易手续费和小费等等。只要为社区发展做出贡献，任何人都可以申请资金支持。

#### 4.3.2 信用值成长模型

为了平台用户健康发展，我们设计一个信用值成长模型及原生代币激励算法。核心意义为：

- 有利平台发展的行为则增加信用值，不利平台发展的行为则扣减信用值。
- 公开透明的信用数据有助于用户选择交易对象。
- 在Polkadot生态系统中，为其他平行链提供信用数据参考。

为了激励平台用户增加信用值，系统初始会设定一个信用值与原生代币价值等式（该等式日后可以通过社区治理变更。），假设：1 信用值 = 0.001 原生代币。用户完成购物交易，并且购物票据验证通过，能够增加账户信用值，程序会根据新增信用值计算账户获得原生代币数量，并纪录在奖励映射表。用户领取奖励时，有部分比例的奖励捐给国库。

#### 4.3.3 仲裁者

普通用户注册仲裁者需要冻结一定原生代币作为申请条件，并由理事会审核。成为仲裁者后，有以下注意事项：

- 假设以7天作为一个监测周期，仲裁者每天需要进行签到，周期内签到天数大于一半，获得信用增值；少于一半，信用减值，并罚没冻结金额。
- 普通用户代购交易过程产生纠纷，可提交仲裁请求，系统随机分配1名当天签到仲裁者负责处理。仲裁者仲裁纠纷完成后，将获得部分保证金，同时增加信用值。

#### 4.3.4 验票人

Shopbring为验证购物过程是否真实发生，引入了验票人角色。该角色为网络提供验证购物票据的可信任服务。例如在中国，大部分的电商平台都提供了申领国家税务局开出的电子发票功能。通过验证电子发票真伪，可以确定消费过程是否发生过。Shopbing对验票人有以下设计需求：

- 用户提交注册验票人资料，需要等待理事会审核。当理事会有过半的成员投赞成票后审核则通过。
- 验票人需要提供一个验证票据的API服务和Shopbring node。Shopbring node的off-chain worker会把未验证的代购订单的商品票据提交给验票人的验证票据的API。
- 验票人把商品票据的验证结果提交上链，必须有一半以上的验票人提供通过，该商品的价值才能转化为信用值增加到交易双方。

#### 4.3.5 邀请人奖励

刚开始时，代购者在平台没有原生币，无法进行链上操作。为了解决此问题，我们设计了邀请人奖励。
普通用户持有原生币都可以成为邀请人，操作如下：

1. 邀请人随机生成`ed25519`密钥对，提交成为邀请人，参数有：发送者地址，`ed25519`公钥，单笔赠金数，最大可邀请人数。
1. 邀请人提供`ed25519`私钥给被邀请人，被邀请人利用私钥签名账户公钥，得到“接受邀请签名”。
1. 被邀请人，提交接受邀请，参数有：发送者地址，接受邀请签名，邀请人账户地址。
1. 系统使用`ed25519`算法验证：发送者地址，接受邀请签名，邀请人的`ed25519`公钥是通过。通过后，单笔赠金数转账给被邀请人，这笔交易单的手续费无需支出。
1. 被邀请人每完成一笔代购交易，自己的信用值会增加，同时邀请他的人的信用值也会小量增加。

#### 4.3.6 代购交易流程

> 用户在平台不断发生代购交易，系统会记录相当庞大的订单数据。如果把订单数据存储在链上，将会产生非常大的存储成本。因此我们会开发一个链下的订单管理系统，用于存储详细的购物订单信息，发货信息，发票信息，退货信息，这些信息会进行序列化并哈希后才存储到链上。该系统是部署在我们管理的中心化服务器，会采用像polkassembly.io那样可以使用Polkadot钱包签名授权登录，普通账户只能访问自己的订单数据。验票人可以访问待验证的商品发票数据和其关联的商品明细。

代购交易过程有以下几个阶段：

1. 消费者添加外站的商品到购物车，直到满意后，下一步填写收货地址，并确认下单，订单信息保存在链下订单系统。
2. 消费者选择要支付的加密货币，填写支付数量和小费，发布代购订单到链上，提交关键参数：发起者地址，加密货币类型，支付金额，小费金额，信用值要求，保证金要求，订单哈希凭证。此阶段消费者也可以手动关闭订单。
3. 代购者在链上接受代购订单。
4. 代购者提交商家发货信息，详细信息记录在链下订单系统。链上提交确认商家发货。提交关键参数：发货信息哈希凭证，实际法币支付金额。
5. 消费者确认收货或申请退货。
    5.1 消费者在链上确认收货，代购交易完成。
    5.2 消费者在链上申请退货，链下订单系统保存：退货原因等信息。
    5.3 代购者联系商家解决退货，提交退货地址信息到链下订单系统。
    5.4 消费者执行退货，提交退换运单号到链下订单系统，链上提交执行退货，提交关键参数：退货信息哈希凭证。
    5.5 商家确认收到货后，代购者在链上确认退货成功。系统会退回冻结的支付金额给消费者，小费则支付给代购者。
6. 交易完结后，消费者或代购者提交发票信息到链下订单系统，链上提交请求验证发票凭证，提交关键参数：订单哈希凭证，发票哈希凭证。
7. 验票人读取链上待验证的发票哈希凭证，查询链下订单系统的发票信息，请求发票验证API验证真伪，确认购物过程是否真实发生。当发票凭证满足过半的验票人验证真实后，系统将会增加购物双方的信用值。

每个阶段都有操作时限，如果超时，有以下处理情况：

- 当代购者接受了代购订单而超过购物限制时间，订单自动关闭，代购者的保证金支付给消费者，锁定的支付金额和小费退回消费者。
- 当消费者超过了确认收货的限制时间，订单自动完成，支付金额和小费转给代购者。
- 当消费者申请退货，但代购者超过了回应退货限制时间，订单自动关闭，代购者的保证金支付给消费者，解锁商品金额退回消费者。
- 当消费者超过了提交退货运单的限制时间，订单自动完成，支付金额和小费转给代购者。
- 当代购者超过验收退货的限制时间，订单自动完成。系统会把支付金额退回消费者，小费转给代购者。

#### 4.3.7 退货纠纷申诉

在退货过程中难免会产生一些纠纷，交易双方都可提交申诉，让仲裁者介入。仲裁者一般根据商品所属的电商平台服务条款来确定仲裁结果，有如下几种情况：

- 代购者购买行为不符合电商平台服务条款，消费者没有收到期望商品，属于代购者责任。
- 消费者退货行为符合电商平台服务条款，但代购者没有尽责提供帮助，属于代购者责任。
- 消费者退货行为不符合电商平台服务条款，代购者已尽责提供帮助，属于消费责任。

仲裁者完成仲裁，确定胜负方。胜方和仲裁者将获得信用值增加和保证金，败方则扣减信用值。

#### 4.3.8 国库收入与用途

国库的收入来源以下几个方式：

- 链上交易手续费。
- 代购交易的小费抽成比例。
- 罚没的保证金抽成比例。
- 原生代币空投抽成比例。

国库有以下用途：

- 服务器运营费用。
- 程序代码审计。
- 生态系统商业合作。
- 营销活动。
- 社区活动和研讨会。
- 软件开发。

## 5. 生态系统架构

![生态系统架构图](https://wiki.shopbring.network/resources/Shopbring-architecture.jpg)

整个生态系统划分为3块：**业务参与者**，**Shopbring**，**Polkadot生态**。

- **业务参与者**包括：外部用户，电商平台，场外交易市场，加密货币钱包等等。
- **Shopbring**是底层由Substrate建立的区块链系统，作为平行链连接到Polkadot。它不需要定制自己的网络共识，但需要有自己的民主治理机制。
- **Polkadot生态系统**是一个无限扩展的区块链网络，会有很多专注于某项业务的平行链丰富这个网络，使得Shopbring只需要做好自己的事情。

## 6. 商业模式

目前我们还没发现有使用加密货币做支付的区块链电商平台。由于传统电商平台技术已经非常成熟，服务体验也非常好，要让商家花成本迁移到区块链的电商平台是十分困难的。
得益于Polkadot生态系统拥有众多DeFi平行链，我们可以透过DeFi所产生的较高的收益回报来吸引传统的电商用户来为加密货币用户提供购物渠道。如图所示的商业模式：

![商业模式图](https://wiki.shopbring.network/resources/Shopbring-business.jpg)

1. 消费者转账DOT到Acala账户，并兑换成L-DOT。L-DOT是Acala发行的一种不但能获得DOT Staking收益，同时能自由流动的资产。Polkadot的Staking年化利率平均14%，比较收益率来看，DOT < L-DOT < Staked-DOT。
2. 消费者得Acala账户抵押L-DOT借入aUSD。aUSD是Acala发行的一种锚定(1:1)USD的加密代币，因此aUSD适合用作支付货币。消费者要赎回L-DOT，还需要支付稳定费，参考MakerDAO最大的DAI池借贷为年利息2%。
3. 消费者把Acala账户的aUSD跨链转账到Shopbring。
4. 消费者发布了代购交易请求，使用支付aUSD给代购者。
5. 代购者支付法币给电商平台完成商品买卖。
6. 电商平台发货给消费者。
7. 代购者有了aUSD，可以在Polkadot生态系统自由参与Dapp，或溢价出售到场外交易市场。
8. 当消费者觉得L-DOT回报已达到理想时，即会从场外交易市场购买aUSD。
9. 消费者向Acala账户归还aUSD赎回L-DOT，可以套现L-DOT或参与其他更高收益的项目。

> 在此商业模式中，消费者能获得利润，需要满足L-DOT收益*单价 > (稳定费利息 + 网络手续费 + aUSD溢价差)。

**为何消费者不直接在把aUSD出售到场外交易市场，用法币去电商平台购物呢？**

有以下原因：

- 场外交易市场一般兑换额度比较大，差价比较大，服务商才有利润空间。而Shopbring可以做到小额支付，并以赚小费的方式吸引代购者为消费者服务。
- 场外交易市场有可能存在洗黑钱的商家，用户频繁地法币出入金，可能会被黑钱污染，面临冻结银行账户风险。
- 消费者可以在Shopbring完成代购交易再次获得aUSD，同时增加账户信用值，获得更多原生代币奖励。

## 6. 项目开发进度

- Shopbring的POA测试网已部署，已经完成`invitation`，`generic-asset`和`commissioned-shopping`等模块。
- Shopbring的链下订单系统已经部署，提供API服务，例如：Polkadot钱包用户注册和查询购物订单。
- Shopbring Web App已实现Polkadot钱包登录和代购功能。
- Shopbring Wiki [网站](https://wiki.shopbring.network/)已部署，展示Shopbring系统设计规范等文档。

## 7. 技术难题和解决方案

### 7.1 Substrate版本选择问题

最初，我们基于Substrate v2.0.0进行开发，并在Mac os环境下运行成功。 当我们部署到Linux环境时，它无法成功编译。
最后，我们把Substrate升级到v2.0.1，才解决了编译问题。

### 7.2 在Substrate的Runtime中使用ECC加密算法的问题

在开发`pallet-invitation`时，我们使用了`ed25519`密钥算法来验证签名。该程序通过了单元测试，但在`cargo build`时编译失败。

逻辑代码如下：

```rust

use sp_core::{Pair, ed25519};

let flag = ed25519::Pair::verify_weak(&sig, &msg, &pk);

```

失败日志：

```log

error[E0432]: unresolved import `sp_core::Pair`
    |
30 | use sp_core::{Pair, ed25519};
    |               ^^^^ no `Pair` in the root

error[E0433]: failed to resolve: could not find `Pair` in `ed25519`
    |
252 |             let flag = ed25519::Pair::verify_weak(&sig, &msg, &pk);
    |                                 ^^^^ could not find `Pair` in `ed25519`

```

这是因为`Pair`仅在`std`上可用。最后，我们的解决方案是使用`sp_runtime::traits::Verify`来验证签名。

### 7.3 发送交易不消耗手续费

当我们开发`pallet-invitation`时，受邀者接受邀请后，系统将验证邀请签名。 如果成功，受邀人可以获得邀请人给予的奖金，并且该笔交易不需要手续费。

我们不能简单地将调用方法的weight设置为0来免去手续费，因为手续费的计算还包括交易的字节长度。

最后，我们在pallet中实现`frame_support::unsigned::ValidateUnsigned`接口，它满足验证未签交易需求，受邀人可以提交未签名交易，而无需支付手续费。
